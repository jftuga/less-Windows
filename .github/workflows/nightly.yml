name: nightly

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 0 * * 1,3,5'
  workflow_dispatch:
    
jobs:
  checkver:
    runs-on: ubuntu-latest

    outputs:
      new_version: ${{ steps.check_new_version.outputs.new_version }}

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v4.1.0
    - name: Compare versions
      run: python version_compare.py
    - name: Check if new version exists
      id: check_new_version
      run: |
        # If new.txt exists and is not empty
        if [ -s "new.txt"  ]; then
          NEW_VERSION=$(cat new.txt)
          echo "New version is $NEW_VERSION"
          echo ::set-output name=new_version::$NEW_VERSION
        fi
        
  build:
    runs-on: windows-latest
    needs: checkver
    if: ${{ needs.checkver.outputs.new_version }}
    
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v4.1.0
    - uses: ilammy/msvc-dev-cmd@v1

    - name: Build
      run: python .\build.py
    
    - name: Upload less to artifact
      uses: actions/upload-artifact@v3
      with:
        name: less
        path: less.exe
    - name: Upload lesskey to artifact
      uses: actions/upload-artifact@v3
      with:
        name: lesskey
        path: lesskey.exe

  release:
    needs: [checkver, build]
    if: ${{ github.event_name == 'push' || github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Get less artifact
      uses: actions/download-artifact@v3
      with:
          name: less
    - name: Get lesskey artifact
      uses: actions/download-artifact@v3
      with:
        name: lesskey
    
    - uses: octokit/request-action@v2.x
      id: get_workflow_runtime
      with:
        route: GET /repos/{owner}/{repo}/actions/runs/{run_id}
        owner: ${{ github.repository_owner }}
        repo: less-Windows
        run_id: ${{ github.run_id }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - uses: softprops/action-gh-release@v1
      with:
        files: |
          less.exe
          lesskey.exe
        body: Built with GitHub Actions at ${{ fromJson(steps.get_workflow_runtime.outputs.data).updated_at }}
        tag_name: less-v${{ needs.checkver.outputs.new_version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  winget:
    name: Publish to WinGet
    needs: [checkver, release]
    runs-on: windows-latest # action can only run on Windows

    steps:
    - name: Publish less to WinGet
      uses: vedantmgoyal2009/winget-releaser@v1
      with:
        identifier: JohnTaylor.less
        version: ${{ needs.checkver.outputs.new_version }}
        release-tag: less-v${{ needs.checkver.outputs.new_version }}
        installers-regex: 'less\.exe$'
        token: ${{ secrets.WINGET_TOKEN }}
    - name: Publish lesskey to WinGet
      uses: vedantmgoyal2009/winget-releaser@v1
      with:
        identifier: JohnTaylor.lesskey
        version: ${{ needs.checkver.outputs.new_version }}
        release-tag: less-v${{ needs.checkver.outputs.new_version }}
        installers-regex: 'lesskey\.exe$'
        token: ${{ secrets.WINGET_TOKEN }}
